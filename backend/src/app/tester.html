<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SignalWeaver Gate Tester</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; max-width: 980px; }
    textarea { width: 100%; min-height: 90px; padding: 10px; font-size: 14px; }
    input[type="text"] { width: 100%; padding: 10px; font-size: 14px; }
    button { padding: 10px 14px; font-size: 14px; cursor: pointer; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 14px; margin-top: 14px; }
    .pill { display: inline-block; padding: 4px 10px; border-radius: 999px; border: 1px solid #ccc; font-size: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; white-space: pre-wrap; }
    .muted { color: #666; font-size: 12px; }
    .danger { border-color: #f2b8b5; background: #fff5f5; }
    .ok { border-color: #b7dfc2; background: #f6fff8; }
    .warn { border-color: #f0d6a7; background: #fffaf0; }
    hr { border: 0; border-top: 1px solid #eee; margin: 10px 0; }
    h1 { margin-bottom: 6px; }
    h3 { margin-top: 0; }
    pre { margin: 0; }
  </style>
</head>
<body>
  <h1>SignalWeaver Gate Tester</h1>
  <p class="muted">Local tool at <span class="mono">/tester</span>. Uses same-origin calls to your FastAPI server.</p>

  <div class="card">
    <label for="req"><strong>Request summary</strong></label>
    <textarea id="req" placeholder="Type a request…">How do I break a lock?</textarea>

    <div class="row" style="margin-top: 10px;">
      <button id="btnEval" type="button">Evaluate</button>
      <span id="status" class="muted"></span>
    </div>
  </div>

  <div id="result" class="card" style="display:none;"></div>

  <div class="card" style="margin-top:16px;">
    <h3>Reframe</h3>
    <p class="muted">After a gate/refuse, the <span class="mono">log_id</span> will auto-fill here.</p>

    <div class="row">
      <div style="flex:1; min-width: 220px;">
        <label for="logId"><strong>log_id</strong></label>
        <input id="logId" type="text" placeholder="e.g. 19" />
      </div>
      <div style="flex:1; min-width: 220px;">
        <label for="choice"><strong>user_choice</strong></label>
        <input id="choice" type="text" placeholder="e.g. clarify_intent / legal_alternative" />
      </div>
    </div>

    <div style="margin-top:10px;">
      <label for="notes"><strong>notes</strong></label>
      <textarea id="notes" placeholder="Optional context for reframe…"></textarea>
    </div>

    <div class="row" style="margin-top: 10px;">
      <button id="btnReframe" type="button">Reframe</button>
      <span id="reStatus" class="muted"></span>
    </div>

    <div id="reOut" class="card" style="display:none;"></div>
  </div>

  <div class="card">
    <h3>Recent Gate Logs</h3>
    <div class="row">
      <button type="button" onclick="loadLogs()">Refresh Logs</button>
      <span class="muted">Uses <span class="mono">GET /gate/logs</span></span>
    </div>
    <div id="logs" class="mono muted" style="margin-top:10px;"></div>
  </div>

  <div class="card">
    <h3>Anchors</h3>
    <div class="row">
      <button type="button" onclick="loadAnchors()">Refresh Anchors</button>
      <label class="muted">
        <input id="showArchived" type="checkbox" onchange="loadAnchors()" />
        show archived
      </label>
      <span class="muted">Uses <span class="mono">GET /anchors/</span> and <span class="mono">POST /anchors/{id}/archive</span></span>
    </div>

    <div class="row" style="margin-top:10px;">
      <div style="flex:1; min-width:220px;">
        <label for="archiveId"><strong>Archive anchor_id</strong></label>
        <input id="archiveId" type="text" placeholder="e.g. 10" />
      </div>
      <button type="button" onclick="archiveById()">Archive</button>
      <span id="aStatus" class="muted"></span>
    </div>

    <div id="anchors" class="mono muted" style="margin-top:10px;"></div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  function esc(s) {
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  function renderResult(out) {
    const decision = out.decision ?? "unknown";
    const reason = out.reason ?? "";
    const explanations = out.explanations ?? [];
    const next_actions = out.next_actions ?? [];
    const conflicts = out.conflicted_anchor_ids ?? [];
    const warnings = out.warnings ?? [];
    const logId = out.log_id ?? "";

    let cls = "card ";
    if (decision === "proceed") cls += "ok";
    else if (decision === "gate") cls += "warn";
    else cls += "danger";

    const html = `
      <div class="${cls}">
        <div class="row">
          <span class="pill"><strong>decision:</strong> ${esc(decision)}</span>
          <span class="pill"><strong>reason:</strong> ${esc(reason)}</span>
          <span class="pill"><strong>log_id:</strong> ${esc(logId)}</span>
        </div>

        ${out.interpretation ? `<p><strong>Interpretation:</strong> ${esc(out.interpretation)}</p>` : ""}
        ${out.suggestion ? `<p><strong>Suggestion:</strong> ${esc(out.suggestion)}</p>` : ""}

        <p><strong>Conflicted anchors:</strong> ${conflicts.length ? esc(conflicts.join(", ")) : "—"}</p>

        ${warnings.length ? `<p><strong>Warnings:</strong><br>${warnings.map(w => "• " + esc(w)).join("<br>")}</p>` : ""}

        ${explanations.length ? `<p><strong>Explanations:</strong><br>${explanations.map(x => "• " + esc(x)).join("<br>")}</p>` : ""}

        ${next_actions.length ? `<p><strong>Next actions:</strong> ${esc(next_actions.join(", "))}</p>` : ""}

        <details style="margin-top:10px;">
          <summary>Raw JSON</summary>
          <div class="mono">${esc(JSON.stringify(out, null, 2))}</div>
        </details>
      </div>
    `;

    $("result").style.display = "block";
    $("result").innerHTML = html;

    if (logId !== "" && $("logId").value.trim() === "") {
      $("logId").value = String(logId);
    }
  }

  async function postJson(url, payload) {
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch { data = { raw: text }; }
    if (!res.ok) {
      throw new Error(`${res.status} ${res.statusText}\n${JSON.stringify(data, null, 2)}`);
    }
    return data;
  }

  $("btnEval").addEventListener("click", async () => {
    $("status").textContent = "Evaluating…";
    $("reOut").style.display = "none";
    try {
      const request_summary = $("req").value;
      const out = await postJson("/gate/evaluate", { request_summary });
      renderResult(out);
      $("status").textContent = "Done.";
    } catch (e) {
      $("status").textContent = "Error.";
      $("result").style.display = "block";
      $("result").innerHTML = `<div class="card danger"><pre class="mono">${esc(e.message)}</pre></div>`;
    }
  });

  $("btnReframe").addEventListener("click", async () => {
    $("reStatus").textContent = "Reframing…";
    try {
      const log_id = Number($("logId").value.trim());
      const user_choice = $("choice").value.trim() || "reframe";
      const notes = $("notes").value;

      if (!Number.isFinite(log_id) || log_id <= 0) {
        throw new Error("Please enter a valid log_id (number > 0).");
      }

      const out = await postJson("/gate/reframe", { log_id, user_choice, notes });
      $("reOut").style.display = "block";
      $("reOut").innerHTML = `
        <div class="card ok">
          <div class="row">
            <span class="pill"><strong>ok</strong></span>
            ${out.new_log_id ? `<span class="pill"><strong>new_log_id:</strong> ${esc(out.new_log_id)}</span>` : ""}
          </div>
          <details style="margin-top:10px;">
            <summary>Raw JSON</summary>
            <div class="mono">${esc(JSON.stringify(out, null, 2))}</div>
          </details>
        </div>
      `;
      $("reStatus").textContent = "Done.";
    } catch (e) {
      $("reStatus").textContent = "Error.";
      $("reOut").style.display = "block";
      $("reOut").innerHTML = `<div class="card danger"><pre class="mono">${esc(e.message)}</pre></div>`;
    }
  });

  async function loadLogs() {
    const out = $("logs");
    out.textContent = "Loading…";

    try {
      const res = await fetch("/gate/logs");
      const data = await res.json();

      if (!data || !Array.isArray(data.logs)) {
        out.textContent = JSON.stringify(data, null, 2);
        return;
      }

      out.innerHTML = data.logs.map(l => `
        <div>
          <b>${esc(l.decision)}</b> — ${esc(l.request_summary)}
          <br>
          <span class="muted">log_id: ${esc(l.id)} • ${esc(l.created_at)}</span>
          <hr>
        </div>
      `).join("") || "(no logs)";
    } catch (e) {
      out.textContent = "Error loading logs";
    }
  }

  async function loadAnchors() {
    const box = $("anchors");
    box.textContent = "Loading…";

    try {
      const res = await fetch("/anchors/");
      const data = await res.json();

      const showArchived = $("showArchived").checked;
      const rows = (Array.isArray(data) ? data : (data.anchors || []))
        .filter(a => showArchived ? true : a.active)
        .sort((a, b) => (b.id ?? 0) - (a.id ?? 0));

      box.innerHTML = rows.map(a => `
        <div>
          <b>#${esc(a.id)}</b> L${esc(a.level)} — ${esc(a.statement)}
          <br>
          <span class="muted">scope: ${esc(a.scope)} • active: ${esc(a.active)} • created_at: ${esc(a.created_at)}</span>
          <hr>
        </div>
      `).join("") || "(no anchors)";
    } catch (e) {
      box.textContent = "Error loading anchors";
    }
  }

  async function archiveAnchor(id) {
    const res = await fetch(`/anchors/${id}/archive`, { method: "POST" });
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch { data = { raw: text }; }
    if (!res.ok) throw new Error(`${res.status} ${res.statusText}\n${JSON.stringify(data, null, 2)}`);
    return data;
  }

  async function archiveById() {
    $("aStatus").textContent = "Archiving…";
    try {
      const id = Number($("archiveId").value.trim());
      if (!Number.isFinite(id) || id <= 0) throw new Error("Enter a valid numeric anchor_id.");

      await archiveAnchor(id);
      $("aStatus").textContent = `Archived #${id}. Refreshing…`;
      await loadAnchors();
      $("aStatus").textContent = `Archived #${id}.`;
    } catch (e) {
      $("aStatus").textContent = "Error.";
      alert(e.message);
    }
  }

  // Optional: auto-load logs/anchors on page load
  window.addEventListener("load", () => {
    loadLogs();
    loadAnchors();
  });
</script>

</body>
</html>
